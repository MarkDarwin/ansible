# Import the Fortinet signing key from the Ubuntu keyserver
- name: Import Fortinet GPG key from keyserver
  ansible.builtin.command:
    cmd: "gpg --keyserver keyserver.ubuntu.com --recv-keys 18AC26395E54716D"
  args:
    creates: "/root/.gnupg/pubring.kbx"

# Export and dearmor the key into APT's keyring directory
- name: Export and dearmor Fortinet key
  ansible.builtin.shell: |
    gpg --export 18AC26395E54716D | gpg --dearmor > /usr/share/keyrings/fortinet.gpg
  args:
    creates: "/usr/share/keyrings/fortinet.gpg"

# Add the Fortinet repo using the correct keyring
- name: Add Fortinet repo in .sources format
  ansible.builtin.copy:
    dest: /etc/apt/sources.list.d/forticlient.sources
    content: |
      Types: deb
      URIs: https://repo.fortinet.com/repo/forticlient/7.4/ubuntu22/
      Suites: stable
      Components: non-free
      Signed-By: /usr/share/keyrings/fortinet.gpg
    mode: "0644"

# Pin FortiClient to the Fortinet repo
- name: Pin FortiClient to Fortinet repo
  ansible.builtin.copy:
    dest: /etc/apt/preferences.d/forticlient.pref
    content: |
      Package: forticlient
      Pin: origin "repo.fortinet.com"
      Pin-Priority: 1001
    mode: "0644"

# Update package lists
- name: Update apt cache
  ansible.builtin.apt:
    update_cache: yes

# Install FortiClient
- name: Install FortiClient
  ansible.builtin.apt:
    name: forticlient
    state: present

# Register invitation code if provided
- name: Register invitation code from vault secret
  ansible.builtin.command:
    cmd: "/opt/forticlient/epctrl -c {{ forticlient_invitation_code }}"
  when: forticlient_invitation_code is defined
  no_log: true
